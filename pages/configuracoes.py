#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Sistema de Invent√°rio Web - Configura√ß√µes
P√°gina de configura√ß√µes do sistema
"""

import streamlit as st
import sys
import os

# Adicionar pasta raiz ao path
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

from utils.auth import get_auth, check_authentication
from database.connection import DatabaseConnection
from utils.backup import get_backup_manager
from utils.themes import get_theme_manager
from utils.feedback import get_feedback_manager, NotificationType
import hashlib

# Verificar autentica√ß√£o quando acessado diretamente
if not check_authentication():
    st.stop()

def hash_password(password: str) -> str:
    """Cria hash da senha"""
    return hashlib.sha256(password.encode()).hexdigest()

def show_change_password_form():
    """Formul√°rio para alterar senha"""
    with st.form("change_password_form"):
        st.markdown("#### üîë Alterar Senha")
        
        current_password = st.text_input("Senha Atual", type="password")
        new_password = st.text_input("Nova Senha", type="password")
        confirm_password = st.text_input("Confirmar Nova Senha", type="password")
        
        submitted = st.form_submit_button("Alterar Senha", use_container_width=True)
        
        if submitted:
            if not current_password or not new_password or not confirm_password:
                st.error("‚ö†Ô∏è Todos os campos s√£o obrigat√≥rios")
                return
            
            if new_password != confirm_password:
                st.error("‚ö†Ô∏è As senhas n√£o coincidem")
                return
            
            if len(new_password) < 6:
                st.error("‚ö†Ô∏è A senha deve ter pelo menos 6 caracteres")
                return
            
            # Verificar senha atual
            auth = get_auth()
            user = auth.get_current_user()
            
            if user:
                db = DatabaseConnection()
                
                # Verificar senha atual
                current_hash = hash_password(current_password)
                result = db.execute_query(
                    "SELECT id FROM usuarios WHERE id = ? AND senha = ?",
                    (user['id'], current_hash)
                )
                
                if result:
                    # Atualizar senha
                    new_hash = hash_password(new_password)
                    success = db.execute_update(
                        "UPDATE usuarios SET senha = ? WHERE id = ?",
                        (new_hash, user['id'])
                    )
                    if success:
                        st.success("‚úÖ Senha alterada com sucesso!")
                    else:
                        st.error("‚ùå Erro ao alterar senha")
                else:
                    st.error("‚ö†Ô∏è Senha atual incorreta")
            else:
                st.error("‚ö†Ô∏è Erro ao identificar usu√°rio")

def show_activity_log():
    """Mostra log de atividades do usu√°rio"""
    auth = get_auth()
    user = auth.get_current_user()
    
    if user:
        db = DatabaseConnection()
        
        # Buscar registros de auditoria do usu√°rio
        logs = db.execute_query("""
            SELECT timestamp as data_hora, acao, detalhes 
            FROM auditoria 
            WHERE usuario = ? 
            ORDER BY timestamp DESC 
            LIMIT 20
        """, (user['usuario'],))
        
        st.markdown("#### üìã √öltimas Atividades")
        
        if logs:
            import pandas as pd
            df = pd.DataFrame(logs)
            df['data_hora'] = pd.to_datetime(df['data_hora'])
            df['data_hora'] = df['data_hora'].dt.strftime('%d/%m/%Y %H:%M:%S')
            
            # Usar fun√ß√£o segura para exibir DataFrame
            from utils.dataframe_utils import safe_dataframe
            safe_dataframe(
                df,
                column_config={
                    "data_hora": "Data/Hora",
                    "acao": "A√ß√£o",
                    "detalhes": "Detalhes"
                },
                use_container_width=True,
                hide_index=True
            )
        else:
            st.info("üìù Nenhuma atividade registrada")
    else:
        st.error("‚ö†Ô∏è Erro ao identificar usu√°rio")

def show():
    """Fun√ß√£o principal da p√°gina Configura√ß√µes"""
    
    # Verificar autentica√ß√£o
    auth = get_auth()
    if not auth.is_authenticated():
        auth.show_login_page()
        return
    
    user = auth.get_current_user()
    
    st.markdown(f"## ‚öôÔ∏è Configura√ß√µes do Sistema")
    st.markdown("Configura√ß√µes gerais e prefer√™ncias do usu√°rio")
    
    # Se√ß√µes de configura√ß√µes
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs(["üë§ Perfil", "üé® Apar√™ncia", "üîß Sistema", "üîí Seguran√ßa", "üìä Relat√≥rios", "üíæ Backup"])
    
    with tab1:
        st.markdown("### üë§ Informa√ß√µes do Perfil")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.text_input("Nome", value=user['nome'] if user else "", disabled=True)
            st.text_input("Usu√°rio", value=user['usuario'] if user else "", disabled=True)
        
        with col2:
            st.text_input("Tipo de Usu√°rio", value="Administrador", disabled=True)
            if user and 'ultimo_acesso' in user:
                st.text_input("√öltimo Acesso", value=user['ultimo_acesso'], disabled=True)
        
        st.markdown("---")
        st.info("Para alterar informa√ß√µes do perfil, entre em contato com o administrador do sistema.")
    
    with tab2:
        st.markdown("### üé® Personaliza√ß√£o de Apar√™ncia")
        
        # Sistema de temas
        theme_manager = get_theme_manager()
        feedback_manager = get_feedback_manager()
        
        theme_manager.show_theme_selector()
        
        st.markdown("---")
        
        # Configura√ß√µes de acessibilidade
        st.markdown("### ‚ôø Acessibilidade")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # Alto contraste
            if st.checkbox("üî≤ Alto Contraste", help="Ativar modo de alto contraste para melhor legibilidade"):
                theme_manager.set_theme("high_contrast")
                feedback_manager.show_notification("üé® Tema de alto contraste ativado!", NotificationType.SUCCESS)
            
            # Texto grande
            font_size = st.selectbox(
                "üìè Tamanho da Fonte",
                ["Pequena", "Normal", "Grande", "Extra Grande"],
                index=1,
                help="Ajustar tamanho da fonte para melhor leitura"
            )
        
        with col2:
            # Anima√ß√µes
            animations = st.checkbox("‚ú® Anima√ß√µes", value=True, help="Ativar/desativar anima√ß√µes da interface")
            
            # Modo escuro autom√°tico
            if st.checkbox("üåô Modo Escuro Autom√°tico", help="Alternar para modo escuro baseado no hor√°rio"):
                from datetime import datetime
                current_hour = datetime.now().hour
                if 18 <= current_hour or current_hour <= 6:  # Noite: 18h √†s 6h
                    theme_manager.set_theme("dark")
                    feedback_manager.show_notification("üåô Modo escuro ativado automaticamente!", NotificationType.INFO)
                else:
                    theme_manager.set_theme("default")
                    feedback_manager.show_notification("‚òÄÔ∏è Modo claro ativado automaticamente!", NotificationType.INFO)
        
        # Preview de configura√ß√µes
        if st.expander("üëÅÔ∏è Visualizar Configura√ß√µes"):
            st.info(f"""
            **Configura√ß√µes Atuais:**
            - üé® Tema: {theme_manager.get_current_theme()['name']}
            - üìè Fonte: {font_size}
            - ‚ú® Anima√ß√µes: {'Ativadas' if animations else 'Desativadas'}
            """)
        
        st.markdown("---")
        st.success("üí° **Dica:** As configura√ß√µes de apar√™ncia s√£o salvas automaticamente e aplicadas imediatamente!")
    
    with tab3:
        st.markdown("### üîß Configura√ß√µes do Sistema")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # Cache do sistema
            st.markdown("**üíæ Cache do Sistema**")
            if st.button("üßπ Limpar Cache", use_container_width=True):
                # Simular limpeza de cache
                with st.spinner("Limpando cache..."):
                    import time
                    time.sleep(1)
                feedback_manager = get_feedback_manager()
                feedback_manager.show_notification("üßπ Cache limpo com sucesso!", NotificationType.SUCCESS)
            
            st.selectbox("Idioma", ["Portugu√™s (BR)", "English"], index=0, disabled=True)
        
        with col2:
            # Performance
            st.markdown("**‚ö° Performance**")
            lazy_loading = st.checkbox("üìä Carregamento Lazy", value=True, help="Carregar dados sob demanda")
            compression = st.checkbox("üì¶ Compress√£o de Dados", value=True, help="Comprimir dados para melhor performance")
            
            st.number_input("Timeout da Sess√£o (min)", min_value=15, max_value=480, value=30)
        
        # Configura√ß√µes avan√ßadas
        st.markdown("---")
        
        if st.expander("‚öôÔ∏è Configura√ß√µes Avan√ßadas"):
            st.warning("‚ö†Ô∏è Altere apenas se souber o que est√° fazendo!")
            
            col_adv1, col_adv2 = st.columns(2)
            
            with col_adv1:
                st.number_input("üîÑ Intervalo de Auto-save (seg)", min_value=30, max_value=300, value=60)
                st.selectbox("üóÉÔ∏è Tamanho do Buffer", ["Pequeno", "M√©dio", "Grande"], index=1)
            
            with col_adv2:
                st.number_input("üìä Limite de Registros por P√°gina", min_value=10, max_value=1000, value=100)
                st.checkbox("üîç Log Detalhado", help="Ativar logs detalhados (pode afetar performance)")
        
        # Status do sistema
        st.markdown("---")
        st.markdown("#### üìä Status do Sistema")
        
        col_status1, col_status2, col_status3 = st.columns(3)
        
        with col_status1:
            st.metric("üöÄ Performance", "√ìtima", delta="‚Üë 15%")
        
        with col_status2:
            st.metric("üíæ Uso de Mem√≥ria", "45MB", delta="‚Üì 5MB")
        
        with col_status3:
            st.metric("‚è±Ô∏è Tempo de Resposta", "< 100ms", delta="‚Üì 20ms")
    
    with tab3:
        st.markdown("### üîí Configura√ß√µes de Seguran√ßa")
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("üîë Alterar Senha", use_container_width=True):
                show_change_password_form()
            
            if st.button("üì± Autentica√ß√£o 2FA", use_container_width=True):
                st.info("Funcionalidade em desenvolvimento...")
        
        with col2:
            if st.button("üìã Log de Atividades", use_container_width=True):
                show_activity_log()
            
            if st.button("üîê Sess√µes Ativas", use_container_width=True):
                st.info("Funcionalidade em desenvolvimento...")
        
        st.markdown("---")
        
        # Painel de Rate Limiting (apenas para admin)
        if auth.has_permission('admin'):
            st.markdown("#### üõ°Ô∏è Rate Limiting - Prote√ß√£o contra Ataques")
            
            from utils.rate_limiting import rate_limiter
            
            # Status atual do sistema
            col_status1, col_status2, col_status3 = st.columns(3)
            
            with col_status1:
                st.metric("M√°ximo de Tentativas", "5 por minuto")
            
            with col_status2:
                st.metric("Tempo de Bloqueio", "30 minutos")
            
            with col_status3:
                blocked_clients = rate_limiter.get_all_blocked_clients()
                st.metric("Clientes Bloqueados", len(blocked_clients))
            
            # Lista de clientes bloqueados
            if blocked_clients:
                st.error(f"‚ö†Ô∏è **{len(blocked_clients)} clientes bloqueados:**")
                
                for client in blocked_clients:
                    with st.container():
                        col_client, col_until, col_attempts, col_action = st.columns([3, 3, 2, 2])
                        
                        with col_client:
                            st.text(f"üîí Cliente: {client['client_key'][:12]}...")
                        
                        with col_until:
                            try:
                                from datetime import datetime
                                blocked_until = datetime.fromisoformat(client['blocked_until'])
                                st.text(f"At√©: {blocked_until.strftime('%H:%M:%S')}")
                            except:
                                st.text("At√©: N/A")
                        
                        with col_attempts:
                            st.text(f"Tentativas: {client['attempts_count']}")
                        
                        with col_action:
                            if st.button("üîì Desbloquear", key=f"unblock_{client['client_key']}", help="Desbloquear cliente"):
                                rate_limiter.reset_client(client['client_key'])
                                st.success("Cliente desbloqueado!")
                                st.rerun()
                        
                        st.markdown("---")
            else:
                st.success("‚úÖ Nenhum cliente bloqueado atualmente")
            
            # Status do cliente atual
            current_status = rate_limiter.get_client_status()
            
            st.markdown("#### üìä Status do Cliente Atual")
            
            col_current1, col_current2, col_current3 = st.columns(3)
            
            with col_current1:
                st.metric("Seu ID de Sess√£o", current_status['client_key'][:12] + "...")
            
            with col_current2:
                color = "üî¥" if current_status['is_blocked'] else "üü¢"
                status_text = "Bloqueado" if current_status['is_blocked'] else "Liberado"
                st.markdown(f"**Status:** {color} {status_text}")
            
            with col_current3:
                st.metric("Tentativas Restantes", current_status['remaining_attempts'])
        
        st.markdown("---")
        st.info("üí° Por seguran√ßa, algumas configura√ß√µes requerem confirma√ß√£o por email")
    
    with tab4:
        st.markdown("### üìä Configura√ß√µes de Relat√≥rios")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.selectbox("Formato Padr√£o", ["PDF", "Excel", "CSV"], index=0, disabled=True)
            st.selectbox("Frequ√™ncia de Backup", ["Di√°rio", "Semanal", "Mensal"], index=1, disabled=True)
        
        with col2:
            st.text_input("Email para Relat√≥rios", placeholder="seu@email.com", disabled=True)
            st.checkbox("Receber Alertas por Email", value=True, disabled=True)
        
        st.markdown("---")
        st.warning("‚ö†Ô∏è Configura√ß√µes de relat√≥rios est√£o em desenvolvimento")
    
    # Informa√ß√µes do sistema
    st.markdown("---")
    st.markdown("### üìã Informa√ß√µes do Sistema")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.info("""
        **üåê Sistema Web**
        - Vers√£o: 2.0
        - Framework: Streamlit
        - Banco: SQLite
        """)
    
    with col2:
        st.info("""
        **üîí Seguran√ßa**
        - Autentica√ß√£o: Ativa
        - Criptografia: SHA256
        - Sess√µes: Seguras
        """)
    
    with col3:
        st.info("""
        **üìä Performance**
        - Status: Online
        - Cache: Ativo
        - Backup: Autom√°tico
        """)
    
    with tab6:
        st.markdown("### üíæ Sistema de Backup")
        
        # Verificar se √© admin
        if not auth.has_permission('admin'):
            st.warning("‚õî Acesso restrito a administradores")
            return
        
        backup_mgr = get_backup_manager()
        
        # Estat√≠sticas de backup
        st.markdown("#### üìä Estat√≠sticas")
        stats = backup_mgr.get_backup_stats()
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("Total Backups", stats['total_backups'])
        
        with col2:
            if stats['total_size'] > 0:
                size_mb = stats['total_size'] / (1024 * 1024)
                st.metric("Tamanho Total", f"{size_mb:.1f} MB")
            else:
                st.metric("Tamanho Total", "0 MB")
        
        with col3:
            if stats['last_backup']:
                st.metric("√öltimo Backup", stats['last_backup'].strftime('%d/%m/%Y %H:%M'))
            else:
                st.metric("√öltimo Backup", "Nenhum")
        
        with col4:
            if stats['oldest_backup']:
                st.metric("Backup Mais Antigo", stats['oldest_backup'].strftime('%d/%m/%Y'))
            else:
                st.metric("Backup Mais Antigo", "Nenhum")
        
        st.markdown("---")
        
        # A√ß√µes de backup
        st.markdown("#### üõ†Ô∏è A√ß√µes")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("üíæ Criar Backup Manual", use_container_width=True, type="primary"):
                with st.spinner("Criando backup..."):
                    success, result = backup_mgr.create_backup(compress=True)
                    
                    if success:
                        st.success(f"‚úÖ Backup criado: {os.path.basename(result)}")
                        st.rerun()
                    else:
                        st.error(f"‚ùå Erro: {result}")
        
        with col2:
            if st.button("üßπ Limpar Backups Antigos", use_container_width=True):
                with st.spinner("Limpando backups antigos..."):
                    removed_count, removed_files = backup_mgr.clean_old_backups(keep_days=30, keep_count=5)
                    
                    if removed_count > 0:
                        st.success(f"‚úÖ {removed_count} backups antigos removidos")
                        with st.expander("Ver arquivos removidos"):
                            for filename in removed_files:
                                st.text(f"üóëÔ∏è {filename}")
                        st.rerun()
                    else:
                        st.info("‚ÑπÔ∏è Nenhum backup antigo para remover")
        
        with col3:
            if st.button("üîÑ Backup Autom√°tico", use_container_width=True):
                with st.spinner("Verificando backup autom√°tico..."):
                    created = backup_mgr.auto_backup()
                    
                    if created:
                        st.success("‚úÖ Backup autom√°tico criado")
                        st.rerun()
                    else:
                        st.info("‚ÑπÔ∏è Backup autom√°tico n√£o necess√°rio (j√° existe backup de hoje)")
        
        st.markdown("---")
        
        # Lista de backups
        st.markdown("#### üìã Backups Dispon√≠veis")
        
        backups = backup_mgr.list_backups()
        
        if backups:
            for backup in backups[:10]:  # Mostrar apenas os 10 mais recentes
                col1, col2, col3, col4 = st.columns([3, 2, 2, 1])
                
                with col1:
                    st.text(backup['filename'])
                
                with col2:
                    st.text(backup['date'].strftime('%d/%m/%Y %H:%M'))
                
                with col3:
                    size_mb = backup['size'] / (1024 * 1024)
                    compression = " (Comprimido)" if backup['compressed'] else ""
                    st.text(f"{size_mb:.1f} MB{compression}")
                
                with col4:
                    if st.button("üîÑ", key=f"restore_{backup['filename']}", help="Restaurar backup"):
                        if st.button("‚ö†Ô∏è Confirmar Restaura√ß√£o", key=f"confirm_{backup['filename']}", type="secondary"):
                            with st.spinner("Restaurando backup..."):
                                success, result = backup_mgr.restore_backup(backup['filepath'])
                                
                                if success:
                                    st.success("‚úÖ Backup restaurado com sucesso!")
                                    st.warning("‚ö†Ô∏è Reinicie a aplica√ß√£o para aplicar as mudan√ßas")
                                else:
                                    st.error(f"‚ùå Erro: {result}")
        else:
            st.info("üìù Nenhum backup encontrado. Crie o primeiro backup manual.")
    
    # Informa√ß√µes sobre desenvolvimento
    st.markdown("---")
    st.success("""
    ‚úÖ **Funcionalidades implementadas:**
    - ‚úÖ Interface de configura√ß√µes
    - ‚úÖ Sistema de backup completo
    - ‚úÖ Controle de permiss√µes por role
    - ‚úÖ Seguran√ßa aprimorada (bcrypt, prote√ß√£o for√ßa bruta)
    - ‚úÖ Auditoria de a√ß√µes
    - ‚úÖ Relat√≥rios com exporta√ß√£o
    """)

if __name__ == "__main__":
    from pages import configuracoes
    configuracoes.show()